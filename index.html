<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <!-- Créé par Iban -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Senpai Stream">
  <title>Senpai Stream</title>
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@300&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f7f6f3;
      --fg: #1a1a1a;
      --muted: #9a9a8e;
      --border: #e0dfd9;
      --accent: #1a1a1a;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: 'DM Sans', sans-serif;
      font-weight: 300;
      -webkit-font-smoothing: antialiased;
    }

    #install {
      display: none;
      min-height: 100dvh;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      padding: 48px 36px;
      gap: 0;
      animation: fadein 0.6s ease both;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 20px;
    }

    h2 {
      font-size: clamp(28px, 7vw, 42px);
      font-weight: 400;
      line-height: 1.15;
      letter-spacing: -0.02em;
      color: var(--fg);
      margin-bottom: 32px;
    }

    h2 span {
      color: var(--muted);
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 48px;
    }

    .step {
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }

    .step-num {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      padding-top: 2px;
      min-width: 18px;
    }

    .step-text {
      font-size: 15px;
      line-height: 1.5;
      color: var(--fg);
    }

    .step-text strong {
      font-weight: 500;
    }

    .divider {
      width: 32px;
      height: 1px;
      background: var(--border);
      margin-bottom: 48px;
    }

    #go {
      appearance: none;
      background: none;
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: 13px 28px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: var(--fg);
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.01em;
    }

    #go:hover:not(:disabled) {
      background: var(--fg);
      border-color: var(--fg);
      color: var(--bg);
    }

    #go:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .arrow {
      font-size: 13px;
      transition: transform 0.2s ease;
    }

    #go:hover:not(:disabled) .arrow {
      transform: translateX(3px);
    }

    #log {
      margin-top: 28px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.8;
      white-space: pre-wrap;
      word-break: break-all;
      max-width: 360px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #log.visible { opacity: 1; }
  </style>
</head>
<body>
  <div id="install">
    <p class="label">Senpai Stream</p>
    <h2>Installe<br><span>l'application.</span></h2>
    <div class="steps">
      <div class="step">
        <span class="step-num">01</span>
        <span class="step-text">Appuie sur <strong>Partager</strong> en bas de Safari</span>
      </div>
      <div class="step">
        <span class="step-num">02</span>
        <span class="step-text">Choisis <strong>Ajouter à l'écran d'accueil</strong></span>
      </div>
      <div class="step">
        <span class="step-num">03</span>
        <span class="step-text">Ouvre l'app depuis ton écran d'accueil</span>
      </div>
    </div>
    <div class="divider"></div>
    <button id="go">
      Continuer quand même
      <span class="arrow">→</span>
    </button>
    <div id="log"></div>
  </div>

<script>
  const PROXIES = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://thingproxy.freeboard.io/fetch/${url}`,
  ];

  const TARGET = "https://senpai.wiki/";
  const logEl = document.getElementById("log");

  function log(msg) {
    console.log(msg);
    if (logEl) {
      logEl.classList.add("visible");
      logEl.textContent += msg + "\n";
    }
  }

  async function tryProxy(proxyFn) {
    const proxyUrl = proxyFn(TARGET);
    log("→ " + proxyUrl);
    const res = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, "text/html");
    const link = doc.querySelector("a.url-display");
    if (!link) throw new Error("a.url-display introuvable");
    log("✓ " + link.href);
    return link.href;
  }

  async function scrapeAndRedirect() {
    log("Recherche du lien...");
    for (const proxyFn of PROXIES) {
      try {
        const url = await tryProxy(proxyFn);
        window.location.replace(url);
        return;
      } catch (e) {
        log("✗ " + e.message);
      }
    }
    log("Aucun proxy disponible.");
    alert("Impossible de récupérer le lien. Réessaie plus tard.");
  }

  (async () => {
    const isStandalone =
      window.navigator.standalone === true ||
      window.matchMedia("(display-mode: standalone)").matches;

    if (isStandalone) {
      await scrapeAndRedirect();
    } else {
      const installEl = document.getElementById("install");
      installEl.style.display = "flex";

      document.getElementById("go").onclick = async () => {
        const btn = document.getElementById("go");
        btn.disabled = true;
        btn.innerHTML = `Chargement <span class="arrow">...</span>`;
        await scrapeAndRedirect();
        btn.disabled = false;
        btn.innerHTML = `Continuer quand même <span class="arrow">→</span>`;
      };
    }
  })();
</script>
</body>
</html>
