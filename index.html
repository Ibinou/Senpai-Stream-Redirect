<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <!-- CrÃ©Ã© par Iban -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Senpai Stream">
  <title>Senpai Stream</title>
  <link rel="apple-touch-icon" href="icon.png">
</head>
<body>
  <div id="install" style="display:none;">
    <h2>ðŸ“² Installer Senpai Stream</h2>
    <p>
      1. Appuie sur le bouton <strong>Partager</strong> en bas de Safari<br>
      2. Choisis <strong>Ajouter Ã  l'Ã©cran d'accueil</strong><br>
      3. Ouvre l'app depuis ton Ã©cran d'accueil
    </p>
    <button id="go">
      Continuer vers Senpai Stream
    </button>
  </div>

<script>
  async function scrapeAndRedirect() {
    const targetUrl = "https://senpai.wiki/";
    const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(targetUrl);
    console.log("Fetch en cours...", proxyUrl);
    try {
      const res = await fetch(proxyUrl);
      console.log("RÃ©ponse reÃ§ue:", res.status);
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const link = doc.querySelector("a.url-display");
      console.log("Lien trouvÃ©:", link);
      const url = link ? link.href : null;
      console.log("URL extraite:", url);
      if (url) {
        console.log("Redirection vers:", url);
        window.location.replace(url);
      } else {
        console.warn("Aucun lien trouvÃ©");
        alert("Lien introuvable.");
      }
    } catch (e) {
      console.error("Erreur fetch:", e);
      alert("Erreur de chargement.");
    }
  }

  (async () => {
    console.log("Script lancÃ©");
    const isStandalone =
      window.navigator.standalone === true ||
      window.matchMedia("(display-mode: standalone)").matches;
    console.log("isStandalone:", isStandalone);

    // ðŸ‘‰ Si installÃ© : scrape et redirige automatiquement
    if (isStandalone) {
      console.log("Mode standalone dÃ©tectÃ©");
      await scrapeAndRedirect();
    }
    // ðŸ‘‰ Sinon : afficher le tuto avec bouton qui scrape aussi
    else {
      console.log("Mode navigateur normal");
      document.getElementById("install").style.display = "block";
      document.getElementById("go").onclick = async () => {
        console.log("Bouton cliquÃ©");
        await scrapeAndRedirect();
      };
    }
  })();
</script>
</body>
</html>
